name: Docker-CI

on:
  push:
    branches: [docker]
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    branches: [docker]

jobs:
  build-frontend-app:
    concurrency: 
      group: ${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker-practice/actions-setup-docker@fd7ecdac7caf8e2c541a48c9bcc280aae59a8461 # master

      - name: Restore the cache
        uses: actions/cache/restore@v3
        id: restore-cache
        with:
          path: .docker-cargo-cache
          key: docker-cargo-cache_${{ runner.os }}

      - name: Build the app
        id: build
        run: |
          mkdir -p .docker-cargo-cache
          cd frontend/scripts/docker-buildfiles
          sed -i -e 's|^#CI-CACHE-INJECT-MARKER:.*|COPY .docker-cargo-cache $cargo_cache|' Dockerfile
          sed -i -e 's|^#CI-CACHE-RETRIEVE-MARKER:.*|COPY --from=builder $cargo_cache $cargo_cache|' Dockerfile
          cat Dockerfile
          docker-compose build --progress=plain

      - name: Try to retrieve the cache
        if: ${{ steps.build.outcome == 'success' }}
        continue-on-error: true
        run: |
          docker run -v "$PWD"/.tmp:/cache --rm --entrypoint cp appflowy/appflowy:latest -r /cargo-cache /cache
          mv "$PWD"/.tmp/cargo-cache .docker-cargo-cache
          rm -rf "$PWD"/.tmp

      - name: Save the cache
        if: ${{ github.ref == 'refs/heads/docker' }}
        uses: actions/cache/save@v3
        with:
          path: .docker-cargo-cache
          key: ${{ steps.restore-cache.outputs.cache-primary-key }}
