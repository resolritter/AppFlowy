name: Docker-CI

on:
  push:
    branches:
      - docker
  pull_request:
    types: [opened, edited]

jobs:
  build-frontend-app:
    if: ${{ github.base_ref == 'docker' || github.head_ref == null || github.ref == 'refs/heads/docker' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker-practice/actions-setup-docker@fd7ecdac7caf8e2c541a48c9bcc280aae59a8461 # master

      # Only cache the Docker volumes on main, not on pull requests, to avoid
      # overriding the cache with artifacts from unmerged code
      - name: Cache the Docker volumes' cache on main
        uses: actions/cache@v3
        if: ${{ github.ref == 'refs/heads/docker' }}
        with:
          path: /var/lib/docker/volumes
          key: docker-volumes

      # We don't need this step on main because it's redundant with the step above
      - name: Restore the Docker volumes' cache
        uses: actions/cache/restore@v3
        if: ${{ github.ref != 'refs/heads/docker' }}
        with:
          path: /var/lib/docker/volumes
          key: docker-volumes

      - name: List cached Docker volumes
        run: ls /var/lib/docker/volumes || true

      - name: Build the app
        working-directory: frontend/scripts/docker-buildfiles
        run: docker-compose build --progress=plain
