name: Docker-CI

on:
  push:
    branches: [docker]
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]
    branches: [docker]

jobs:
  build-frontend-app:
    concurrency: 
      group: docker_ci-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout source code
        uses: actions/checkout@v3

      - name: Set up Docker
        uses: docker-practice/actions-setup-docker@fd7ecdac7caf8e2c541a48c9bcc280aae59a8461 # master

      - name: Restore the cache
        uses: actions/cache/restore@v3
        id: RestoreCache
        with:
          path: .docker-cargo-cache
          key: docker-cargo-cache_${{ runner.os }}

      - name: Build the app
        id: Build
        run: |
          mkdir -p .docker-cargo-cache
          cd frontend/scripts/docker-buildfiles
          sed -i \
            -e 's|^#CI-CACHE-INJECT-MARKER:.*|COPY .docker-cargo-cache /cargo-cache|' \
            -e 's|^#CI-CACHE-RETRIEVE-MARKER:.*|COPY --from=builder /cargo-cache /cargo-cache|' \
            Dockerfile
          cat Dockerfile
          docker-compose build --progress=plain

      - name: Retrieve build cache
        id: RetrieveBuildCache
        if: ${{ github.ref == 'refs/heads/docker' && steps.Build.outcome == 'success' }}
        continue-on-error: true
        run: |
          mkdir .tmp
          docker run --rm \
            -v "$PWD"/.tmp:/cache \
            --entrypoint cp appflowy/appflowy:latest -r /cargo-cache /cache
          mv .tmp/cargo-cache .docker-cargo-cache
          find .docker-cargo-cache -type f -mtime +14 -delete
          rm -rf .tmp

      - name: Save build cache
        if: ${{ github.ref == 'refs/heads/docker' && steps.RetrieveBuildCache.outcome == 'success' }}
        uses: actions/cache/save@v3
        with:
          path: .docker-cargo-cache
          key: ${{ steps.RestoreCache.outputs.cache-primary-key }}
